
<!DOCTYPE HTML>
<html lang="cn" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Run Loop 记录与源码注释(作者Kylin) · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-multipart/multipart.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="CFArray 的历史渊源及实现原理.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    简介
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Part 1 - iOS Runtime 源码解析</li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    objc/runtime.h 708
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="../Runtime/浅谈Associated Objects.html">
            
                <a href="../Runtime/浅谈Associated Objects.html">
            
                    
                    浅谈Associated Objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="../Runtime/objc_msgSend消息传递学习笔记 - 对象方法消息传递流程.html">
            
                <a href="../Runtime/objc_msgSend消息传递学习笔记 - 对象方法消息传递流程.html">
            
                    
                    对象方法消息传递流程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="../Runtime/objc_msgSend消息传递学习笔记 - 消息转发.html">
            
                <a href="../Runtime/objc_msgSend消息传递学习笔记 - 消息转发.html">
            
                    
                    消息转发过程分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="../Runtime/用 isa 承载对象的类信息.html">
            
                <a href="../Runtime/用 isa 承载对象的类信息.html">
            
                    
                    用 isa 承载对象的类信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.5" data-path="../Runtime/weak 弱引用的实现方式.html">
            
                <a href="../Runtime/weak 弱引用的实现方式.html">
            
                    
                    weak 弱引用的实现方式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="../Runtime/load 方法全程跟踪.html">
            
                <a href="../Runtime/load 方法全程跟踪.html">
            
                    
                    load 方法全程跟踪
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.7" data-path="../Runtime/浅谈 block（1） - clang 改写后的 block 结构.html">
            
                <a href="../Runtime/浅谈 block（1） - clang 改写后的 block 结构.html">
            
                    
                    浅谈 block - clang 改写后的 block 结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8" data-path="../Runtime/浅谈 block（2） - 截获变量方式.html">
            
                <a href="../Runtime/浅谈 block（2） - 截获变量方式.html">
            
                    
                    浅谈 block - 截获变量方式
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 2 - macOS & iOS 系统源码分析</li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    cctools/include/mach-o 895
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../../C/mach-o/Mach-O 文件格式探索.html">
            
                <a href="../../C/mach-o/Mach-O 文件格式探索.html">
            
                    
                    Mach-O 文件格式探索
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 3 - Foundation 框架源码分析</li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    Foundation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="从经典问题来看 Copy 方法.html">
            
                <a href="从经典问题来看 Copy 方法.html">
            
                    
                    从经典问题来看 Copy 方法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="CFArray 的历史渊源及实现原理.html">
            
                <a href="CFArray 的历史渊源及实现原理.html">
            
                    
                    CFArray 的历史渊源及实现原理
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="4.1.3" data-path="Run Loop 记录与源码注释.html">
            
                <a href="Run Loop 记录与源码注释.html">
            
                    
                    Run Loop 记录与源码注释(作者Kylin)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 4 - UIKit 源码分析</li>
        
        
    
        <li class="chapter " data-level="5.1" >
            
                <span>
            
                    
                    UIKit
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="复用的精妙 - UITableView 复用技术原理分析.html">
            
                <a href="复用的精妙 - UITableView 复用技术原理分析.html">
            
                    
                    复用的精妙 - UITableView 复用技术原理分析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 5 - SDWebImage 源码分析</li>
        
        
    
        <li class="chapter " data-level="6.1" >
            
                <span>
            
                    
                    SDWebImage v3.8.1
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1.1" data-path="../SDWebImage/SDWebImage Source Probe - WebCache.html">
            
                <a href="../SDWebImage/SDWebImage Source Probe - WebCache.html">
            
                    
                    SDWebImage Source Probe: WebCache
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.2" data-path="../SDWebImage/SDWebImage Source Probe - Manager.html">
            
                <a href="../SDWebImage/SDWebImage Source Probe - Manager.html">
            
                    
                    SDWebImage Source Probe: Manager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.3" data-path="../SDWebImage/SDWebImage Source Probe - Downloader.html">
            
                <a href="../SDWebImage/SDWebImage Source Probe - Downloader.html">
            
                    
                    SDWebImage Source Probe: Downloader
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.4" data-path="../SDWebImage/SDWebImage Source Probe - Operation.html">
            
                <a href="../SDWebImage/SDWebImage Source Probe - Operation.html">
            
                    
                    SDWebImage Source Probe: Operation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 6 - Swift 源码分析</li>
        
        
    
        <li class="chapter " data-level="7.1" >
            
                <span>
            
                    
                    Swift v4.0
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="7.1.1" data-path="../../Swift/Swift Probe - Optional.html">
            
                <a href="../../Swift/Swift Probe - Optional.html">
            
                    
                    Swift Probe - Optional
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 7 - Shadowsocks 源码分析</li>
        
        
    
        <li class="chapter " data-level="8.1" >
            
                <span>
            
                    
                    Shadowsocks v4.0
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.1.1" data-path="../../Python/Shadowsocks/Shadowsocks Probe I - Socks5 与 EventLoop 事件分发.html">
            
                <a href="../../Python/Shadowsocks/Shadowsocks Probe I - Socks5 与 EventLoop 事件分发.html">
            
                    
                    Shadowsocks Probe I - Socks5 与 EventLoop 事件分发
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Run Loop 记录与源码注释(作者Kylin)</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <blockquote>
<p>&#x4F5C;&#x8005;&#xFF1A;&#x674E;&#x5B5B;</p>
<p>&#x539F;&#x6587;&#x5730;&#x5740;&#xFF1A;<a href="http://kylinroc.github.io/foundation-run-loop.html" target="_blank">Route 1</a></p>
</blockquote>
<h1 id="run-loop-&#x8BB0;&#x5F55;&#x4E0E;&#x6E90;&#x7801;&#x6CE8;&#x91CA;">Run Loop &#x8BB0;&#x5F55;&#x4E0E;&#x6E90;&#x7801;&#x6CE8;&#x91CA;</h1>
<h2 id="run-loop-&#x662F;&#x4EC0;&#x4E48;">Run Loop &#x662F;&#x4EC0;&#x4E48;</h2>
<p>&#x5E7F;&#x4E49;&#x4E0A;&#x7684;&#x6765;&#x8BF4;&#xFF0C;run loop &#x5C31;&#x662F;&#x6240;&#x8C13;&#x7684; <a href="https://en.wikipedia.org/wiki/Event_loop" target="_blank">event loop</a>&#xFF0C;&#x6216;&#x8005;&#x79F0;&#x4E4B;&#x4E3A;&#x300C;&#x4E8B;&#x4EF6;&#x5FAA;&#x73AF;&#x300D;&#x6216;&#x8005;&#x300C;&#x4E8B;&#x4EF6;&#x5206;&#x53D1;&#x5668;&#x300D;&#x3002;Event loop &#x662F; <a href="https://en.wikipedia.org/wiki/Event-driven_programming" target="_blank">event-driven programming</a>&#xFF08;&#x4E8B;&#x4EF6;&#x9A71;&#x52A8;&#x7F16;&#x7A0B;&#xFF09;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x7EC4;&#x6210;&#x90E8;&#x5206;&#xFF0C;&#x800C;&#x4E8B;&#x4EF6;&#x9A71;&#x52A8;&#x7F16;&#x7A0B;&#x5219;&#x662F; GUI &#x7A0B;&#x5E8F;&#x7684;&#x6700;&#x5E38;&#x89C1;&#x7F16;&#x7A0B;&#x65B9;&#x5F0F;&#xFF08;&#x73B0;&#x5728;&#x4F3C;&#x4E4E;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x4E5F;&#x6709;&#x5F88;&#x591A;&#x5E94;&#x7528;&#xFF0C;&#x4F46;&#x5728; GUI &#x7F16;&#x7A0B;&#x65B9;&#x9762;&#x80AF;&#x5B9A;&#x662F;&#x7ED5;&#x4E0D;&#x8FC7;&#x53BB;&#xFF09;&#x3002;</p>
<p>Event loop &#x7684;&#x601D;&#x60F3;&#x975E;&#x5E38;&#x7B80;&#x5355;&#xFF0C;&#x7528;&#x4E0B;&#x9762;&#x7684;&#x4F2A;&#x4EE3;&#x7801;&#x6765;&#x8868;&#x793A;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
    &#x521D;&#x59CB;&#x5316;();
    <span class="hljs-keyword">while</span> (message != &#x9000;&#x51FA;) {
        &#x5904;&#x7406;&#x4E8B;&#x4EF6;(message);
        message = &#x83B7;&#x53D6;&#x4E0B;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>&#x56DE;&#x5230; macOS/iOS &#x5E73;&#x53F0;&#x4E0A;&#xFF0C;&#x5BF9;&#x4E8E; event loop &#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x6709;&#x4E24;&#x4E2A;&#xFF1A;</p>
<ol>
<li>Foundation &#x6846;&#x67B6;&#x4E2D;&#x7684; <code>NSRunLoop</code></li>
<li>Core Foundation &#x6846;&#x67B6;&#x4E2D;&#x7684; <code>CFRunLoop</code></li>
</ol>
<p>&#x5176;&#x4E2D; <code>NSRunLoop</code> &#x662F;&#x5BF9; <code>CFRunLoop</code> &#x7684;&#x7B80;&#x5355;&#x5C01;&#x88C5;&#xFF0C;&#x9700;&#x8981;&#x7740;&#x91CD;&#x7814;&#x7A76;&#x7684;&#x53EA;&#x6709; <code>CFRunLoop</code>&#x3002;</p>
<h2 id="cfrunloop">CFRunLoop</h2>
<p><code>CFRunLoop</code> &#x7684;&#x5B9E;&#x9645;&#x5B9E;&#x73B0;&#x4E0E; event loop &#x7684;&#x601D;&#x60F3;&#x8FD8;&#x662F;&#x6709;&#x5F88;&#x5927;&#x533A;&#x522B;&#x7684;&#x3002;&#x9996;&#x5148;&#xFF0C;&#x4F7F;&#x7528; <code>CFRunLoop</code> &#x7684;&#x4E3B;&#x4F53;&#x662F;&#x4F7F;&#x7528; <code>CFRunLoop</code> &#x5BF9;&#x8C61;&#xFF08;&#x6216;&#x8005;&#x8BF4;&#x662F;&#x5B9E;&#x4F8B;&#xFF09;&#xFF0C;&#x4F7F;&#x7528;&#x8005;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x521B;&#x5EFA; <code>CFRunLoop</code> &#x5BF9;&#x8C61;&#xFF0C;&#x53EA;&#x80FD;&#x901A;&#x8FC7; <code>CFRunLoopGetCurrent</code> &#x548C; <code>CFRunLoopGetMain</code> &#x51FD;&#x6570;&#x6765;&#x83B7;&#x5F97; <code>CFRunLoop</code> &#x5BF9;&#x8C61;&#x3002;&#x56E0;&#x4E3A; <code>CFRunLoop</code> &#x662F;&#x5728;&#x4E00;&#x6761;&#x7A0B;&#x5E8F;&#x6D41;&#x7A0B;&#xFF08;&#x8C03;&#x7528;&#x6808;&#xFF09;&#x4E0A;&#x8FD0;&#x884C;&#x7684;&#xFF0C;&#x6240;&#x4EE5; <code>CFRunLoop</code> &#x5BF9;&#x8C61;&#x662F;&#x4E0E;&#x7EBF;&#x7A0B;&#x7ED1;&#x5B9A;&#x7684;&#x3002;</p>
<p>&#x56E0;&#x6B64; <code>CFRunLoopGetCurrent</code> &#x51FD;&#x6570;&#x4FBF;&#x662F;&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684; <code>CFRunLoop</code> &#x5BF9;&#x8C61;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x8BDD;&#x4F1A;&#x5219;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x3002;<code>CFRunLoopGetMain</code> &#x5219;&#x662F;&#x83B7;&#x53D6;&#x4E3B;&#x7EBF;&#x7A0B;&#x7684; <code>CFRunLoop</code> &#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x4F7F;&#x7528; <code>CFRunLoopGetCurrent</code> &#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x542F;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684; run loop&#xFF08;&#x4E5F;&#x5C31;&#x662F;&#x521B;&#x5EFA; <code>CFRunLoop</code> &#x5BF9;&#x8C61;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x521A;&#x5F00;&#x542F;&#x7684; run loop &#x5E76;&#x4E0D;&#x662F;&#x5904;&#x4E8E;&#x8FD0;&#x884C;&#x72B6;&#x6001;&#x7684;&#xFF0C;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x8005;&#x8BA9; run loop &#x8FD0;&#x884C;&#x8D77;&#x6765;&#x3002;&#x5728;&#x7814;&#x7A76;&#x5982;&#x4F55;&#x4F7F; run loop &#x8FD0;&#x884C;&#x8D77;&#x6765;&#x548C; run loop &#x8FD0;&#x884C;&#x8D77;&#x6765;&#x540E;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x4E86;&#x89E3; run loop &#x7684;&#x4E00;&#x4E9B;&#x5177;&#x4F53;&#x7ED3;&#x6784;&#x3002;</p>
<p>Run loop &#x9700;&#x8981;&#x5904;&#x7406;&#x56DB;&#x7C7B;&#x4E8B;&#x7269;&#xFF1A;</p>
<ol>
<li><p>Sources</p>
<p> &#x4ECE;&#x540D;&#x5B57;&#x53EF;&#x4EE5;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x6E90;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E8B;&#x4EF6;&#x7684;&#x6765;&#x6E90;&#x3002;Sources &#x5206;&#x4E3A; sources 0 &#x548C; sources 1&#xFF0C;&#x5176;&#x4E2D; sources 1 &#x662F;&#x57FA;&#x4E8E; mach port &#x4E5F;&#x5C31;&#x662F;&#x7AEF;&#x53E3;&#x7684;&#xFF0C;sources 0 &#x5219;&#x662F;&#x9700;&#x8981;&#x624B;&#x52A8;&#x89E6;&#x53D1;&#x7684;&#x3002;&#x7EDF;&#x4E00;&#x88AB;&#x5C01;&#x88C5;&#x4E3A; <code>CFRunLoopSource</code>&#x3002;</p>
</li>
<li><p>Timers</p>
<p> &#x5C31;&#x662F;&#x5B9A;&#x65F6;&#x5668;&#xFF0C;&#x88AB;&#x5C01;&#x88C5;&#x4E3A; <code>CFRunLoopTimer</code>&#x3002;<code>NSTimer</code> &#x4E5F;&#x662F;&#x8FD9;&#x4E2A;&#x73A9;&#x610F;&#xFF08;toll-free bridged&#xFF09;&#x3002;</p>
</li>
<li><p>Observers</p>
<p> &#x8FD9;&#x4E2A;&#x4E25;&#x683C;&#x6765;&#x8BF4;&#x5E76;&#x4E0D;&#x662F;&#x9700;&#x8981;&#x5904;&#x7406;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x800C;&#x662F;&#x7C7B;&#x4F3C; notification &#x6216;&#x8005; delegate &#x4E00;&#x6837;&#x7684;&#x4E1C;&#x897F;&#xFF0C;run loop &#x4F1A;&#x5411; observers &#x6C47;&#x62A5;&#x72B6;&#x6001;&#x3002;&#x88AB;&#x5C01;&#x88C5;&#x4E3A; <code>CFRunLoopObserver</code>&#x3002;</p>
</li>
<li><p>Blocks</p>
<p> &#x8FD9;&#x4E2A;&#x4F3C;&#x4E4E;&#x5728;&#x522B;&#x7684;&#x6587;&#x7AE0;&#x91CC;&#x6CA1;&#x6709;&#x88AB;&#x63D0;&#x5230;&#xFF0C;&#x4ECE; macOS 10.6/iOS 4 &#x5F00;&#x59CB;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>CFRunLoopPerformBlock</code> &#x51FD;&#x6570;&#x5F80; run loop &#x4E2D;&#x6DFB;&#x52A0; blocks&#x3002;</p>
</li>
</ol>
<p>Run loop &#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x5F88;&#x91CD;&#x8981;&#x7684;&#x4E1C;&#x897F;&#x53EB;&#x505A; run loop mode &#x6216;&#x8005;&#x79F0;&#x4E3A;&#x6A21;&#x5F0F;&#xFF0C;run loop &#x8DD1;&#x8D77;&#x6765;&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x6307;&#x5B9A;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x7684;&#x6A21;&#x5F0F;&#xFF0C;<strong>&#x4E0A;&#x9762;&#x56DB;&#x79CD;&#x4E8B;&#x7269;&#x4E5F;&#x90FD;&#x9700;&#x8981;&#x5173;&#x8054;&#x7279;&#x5B9A;&#x7684;&#x6A21;&#x5F0F;</strong>&#x3002;&#x6A21;&#x5F0F;&#x8D77;&#x5230;&#x4E86;&#x7C7B;&#x4F3C; fliter &#x4E00;&#x6837;&#x7684;&#x4F5C;&#x7528;&#xFF0C;<code>CFRunLoop</code> &#x63D0;&#x4F9B;&#x4E86;&#x4E24;&#x4E2A;&#x9ED8;&#x8BA4;&#x7684;&#x6A21;&#x5F0F;&#xFF1A;</p>
<ol>
<li><code>kCFRunLoopDefaultMode</code></li>
<li><code>kCFRunLoopCommonModes</code></li>
</ol>
<p>&#x5176;&#x4E2D; <code>kCFRunLoopDefaultMode</code> &#x662F;&#x521B;&#x5EFA; run loop &#x65F6;&#x540C;&#x65F6;&#x521B;&#x5EFA;&#x7684;&#x4E00;&#x4E2A;&#x6A21;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x79F0;&#x4E4B;&#x4E3A;&#x9ED8;&#x8BA4;&#x6A21;&#x5F0F;&#xFF0C;&#x6CA1;&#x6709;&#x7279;&#x5B9A;&#x8981;&#x6C42;&#x7684;&#x64CD;&#x4F5C;&#x90FD;&#x53EF;&#x4EE5;&#x6254;&#x5230;&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x91CC;&#x3002;</p>
<p><code>kCFRunLoopCommonModes</code> &#x5176;&#x5B9E;&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x771F;&#x6B63;&#x7684;&#x6A21;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5B83;&#x662F; <code>Modes</code> &#x800C;&#x4E0D;&#x662F; <code>Mode</code>&#xFF0C;&#x662F;&#x4E00;&#x4E2A;&#x6A21;&#x5F0F;&#x7684;&#x96C6;&#x5408;&#xFF1A;</p>
<ul>
<li>&#x4F7F;&#x7528; <code>CFRunLoopAddCommonMode</code> &#x51FD;&#x6570;&#x5C06;&#x4E00;&#x4E2A;&#x6A21;&#x5F0F;&#x52A0;&#x5165; common modes &#x96C6;&#x5408;</li>
<li>&#x5728;&#x6DFB;&#x52A0; source&#xFF0C;timer&#xFF0C;observer &#x6216;&#x8005; block &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;&#x679C;&#x6307;&#x5B9A;&#x7684;&#x6A21;&#x5F0F;&#x4E3A; <code>kCFRunLoopCommonModes</code>&#xFF0C;&#x5219;&#x4F1A;&#x88AB;&#x5206;&#x522B;&#x6DFB;&#x52A0;&#x5230; common modes &#x96C6;&#x5408;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x6A21;&#x5F0F;&#x4E2D;</li>
<li><code>kCFRunLoopDefaultMode</code> &#x9ED8;&#x8BA4;&#x662F;&#x5728; common modes &#x4E2D;&#x7684;</li>
</ul>
<p>&#x5173;&#x4E8E; run loop mode &#x4E00;&#x4E2A;&#x7ECF;&#x5178;&#x7684;&#x4F8B;&#x5B50;&#x5C31;&#x662F; scroll view &#x6ED1;&#x52A8;&#x65F6;&#x4F1A;&#x505C;&#x6B62; timer&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x56E0;&#x4E3A; scroll view &#x5728;&#x6ED1;&#x52A8;&#x65F6;&#x5C06; run loop mode &#x5207;&#x6362;&#x5230; <code>UITrackingRunLoopMode</code>&#xFF0C;&#x800C; timer &#x6CE8;&#x518C;&#x5230;&#x4E86; <code>kCFRunLoopDefaultMode</code> &#x5F15;&#x8D77;&#x7684;&#x3002;</p>
<h2 id="&#x8FD0;&#x884C;-run-loop">&#x8FD0;&#x884C; Run Loop</h2>
<p><code>CFRunLoop</code> &#x63D0;&#x4F9B;&#x4E86;&#x4E24;&#x4E2A;&#x51FD;&#x6570;&#x7528;&#x6765;&#x4F7F; run loop &#x8FD0;&#x884C;&#x8D77;&#x6765;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CFRunLoopRun</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;

<span class="hljs-function">CFRunLoopRunResult 
<span class="hljs-title">CFRunLoopRunInMode</span><span class="hljs-params">(CFRunLoopMode mode, 
                   CFTimeInterval seconds, 
                   Boolean returnAfterSourceHandled)</span></span>;
</code></pre>
<p><code>CFRunLoopRunInMode</code> &#x51FD;&#x6570;&#x9700;&#x8981;&#x6307;&#x5B9A;&#xFF1A;</p>
<ul>
<li><code>CFRunLoopMode mode</code>&#xFF1A;&#x4E00;&#x4E2A; run loop mode</li>
<li><code>CFTimeInterval</code>&#xFF1A;&#x6700;&#x591A;&#x80FD;&#x8FD0;&#x884C;&#x591A;&#x4E45;&#xFF08;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF09;</li>
<li><code>Boolean returnAfterSourceHandled</code>&#xFF1A;&#x5904;&#x7406;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;&#x540E;&#x662F;&#x5426;&#x8FD4;&#x56DE;</li>
</ul>
<p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x660E;&#x663E;&#x5BF9; run loop &#x7684;&#x8FD0;&#x884C;&#x6709;&#x5F88;&#x597D;&#x7684;&#x63A7;&#x5236;&#xFF0C;&#x53EF;&#x4EE5;&#x60F3;&#x8C61; scroll view &#x6ED1;&#x52A8;&#x65F6;&#x5C31;&#x662F;&#x9760;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6765;&#x6539;&#x53D8; run loop &#x7684;&#x6A21;&#x5F0F;&#x3002;&#x56E0;&#x6B64; <code>CFRunLoop</code> &#x7684;&#x4F7F;&#x7528;&#x548C;&#x6700;&#x5F00;&#x59CB;&#x63D0;&#x5230;&#x7684; event loop &#x7684;&#x601D;&#x60F3;&#x5C31;&#x6709;&#x70B9;&#x4E0D;&#x4E00;&#x6837;&#x4E86;&#xFF0C;&#x4F7F;&#x7528; <code>CFRunLoop</code> &#x7684;&#x5957;&#x8DEF;&#x53D8;&#x6210;&#x4E0B;&#x9762;&#x8FD9;&#x6837;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
    CFRunLoopRef runLoop = CFRunLoopGetCurrent();

    <span class="hljs-comment">// &#x6DFB;&#x52A0;&#x4E00;&#x4E9B; source&#xFF0C;timer&#xFF0C;observer &#x6216;&#x8005; block</span>

    <span class="hljs-keyword">while</span> (message != &#x9000;&#x51FA;) {
        message = &#x83B7;&#x53D6;&#x6D88;&#x606F;();
        mode = <span class="hljs-comment">// &#x5904;&#x7406;&#x6D88;&#x606F;&#x770B;&#x662F;&#x5426;&#x9700;&#x8981;&#x6539;&#x53D8; mode&#xFF0C;&#x6BD4;&#x5982; scroll view &#x6ED1;&#x52A8;</span>
        time = <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x8D85;&#x65F6;&#x65F6;&#x95F4;</span>
        CFRunLoopRunInMode(mode,
                           time,
                           <span class="hljs-literal">true</span>); <span class="hljs-comment">// &#x731C;&#x6D4B;&#x5927;&#x90E8;&#x5206;&#x65F6;&#x95F4;&#x4E3A; true&#xFF0C;&#x56E0;&#x4E3A;&#x9700;&#x8981;&#x66F4;&#x7075;&#x6D3B;&#x7684;&#x63A7;&#x5236;</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>&#x8FD9;&#x6837;&#x770B;&#x6765; <code>CFRunLoop</code> &#x53EA;&#x662F; event loop &#x7684;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x5B9E;&#x9645;&#x7684;&#x6267;&#x884C;&#x4E8B;&#x4EF6;&#x3002;&#x5F53;&#x7136;&#xFF0C;<code>CFRunLoop</code> &#x8FD8;&#x63D0;&#x4F9B;&#x4E86;&#x95F2;&#x65F6;&#x7761;&#x7720;&#x529F;&#x80FD;&#x6765;&#x4FDD;&#x8BC1;&#x6548;&#x7387;&#x3002;</p>
<p>&#x53CD;&#x8FC7;&#x6765;&#x770B; <code>CFRunLoopRun</code> &#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7B49;&#x540C;&#x4E8E;&#x5728; <code>kCFRunLoopDefaultMode</code> &#x8FD0;&#x884C;&#xFF0C;&#x53EF;&#x4EE5;&#x8FD0;&#x884C;&#x65E0;&#x9650;&#x4E45;&#xFF0C;&#x5904;&#x7406;&#x4E86;&#x4E8B;&#x4EF6;&#x4E0D;&#x9700;&#x8981;&#x8FD4;&#x56DE;&#x800C;&#x662F;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;&#x3002;&#x53EA;&#x80FD;&#x4F7F;&#x7528; <code>CFRunLoopStop</code> &#x51FD;&#x6570;&#x6216;&#x8005;&#x5C06; run loop &#x91CC;&#x6240;&#x6709;&#x7684;&#x4E8B;&#x4EF6;&#x6765;&#x6E90;&#xFF08;sources&#xFF0C;timers&#xFF0C;observers &#x548C; blocks&#xFF09;&#x79FB;&#x9664;&#x6765;&#x4F7F; run loop &#x9000;&#x51FA;&#x3002;&#x56E0;&#x6B64;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x5E76;&#x4E0D;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4F46;&#x5BF9;&#x4E8E;&#x53EA;&#x505A;&#x4E00;&#x4EF6;&#x4E8B;&#x60C5;&#x7684;&#x7EBF;&#x7A0B;&#x6765;&#x8BF4;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x7701;&#x53BB;&#x4E86; run loop &#x7684;&#x5916;&#x5C42;&#x5FAA;&#x73AF;&#xFF08;&#x6700;&#x5178;&#x578B;&#x7684;&#x4F8B;&#x5B50;&#x662F; AFNetworking &#x4E2D;&#x7684;&#x90A3;&#x4E00;&#x4F8B;&#xFF09;&#x3002;</p>
<h2 id="run-loop-&#x8FD0;&#x884C;&#x987A;&#x5E8F;">Run Loop &#x8FD0;&#x884C;&#x987A;&#x5E8F;</h2>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x542F;&#x52A8; run loop &#x540E;&#x6BD4;&#x8F83;&#x5173;&#x952E;&#x7684;&#x8FD0;&#x884C;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li>&#x901A;&#x77E5; observers: <code>kCFRunLoopEntry</code>, &#x8FDB;&#x5165; run loop</li>
<li>&#x901A;&#x77E5; observers: <code>kCFRunLoopBeforeTimers</code>, &#x5373;&#x5C06;&#x5904;&#x7406; timers</li>
<li>&#x901A;&#x77E5; observers: <code>kCFRunLoopBeforeSources</code>, &#x5373;&#x5C06;&#x5904;&#x7406; sources</li>
<li>&#x5904;&#x7406; blocks, &#x53EF;&#x4EE5;&#x5BF9; <code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__</code> &#x51FD;&#x6570;&#x4E0B;&#x65AD;&#x70B9;&#x89C2;&#x5BDF;&#x5230;</li>
<li>&#x5904;&#x7406; sources 0, &#x53EF;&#x4EE5;&#x5BF9; <code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</code> &#x51FD;&#x6570;&#x4E0B;&#x65AD;&#x70B9;&#x89C2;&#x5BDF;&#x5230;</li>
<li>&#x5982;&#x679C;&#x7B2C; 5 &#x6B65;&#x5B9E;&#x9645;&#x5904;&#x7406;&#x4E86; sources 0&#xFF0C;&#x518D;&#x4E00;&#x6B21;&#x5904;&#x7406; blocks</li>
<li>&#x5982;&#x679C;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#xFF0C;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709; GCD &#x4E8B;&#x4EF6;&#x9700;&#x8981;&#x5904;&#x7406;&#xFF0C;&#x6709;&#x7684;&#x8BDD;&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;&#x7B2C; 11 &#x6B65;</li>
<li>&#x901A;&#x77E5; observers: <code>kCFRunLoopBeforeWaiting</code>, &#x5373;&#x5C06;&#x8FDB;&#x5165;&#x7B49;&#x5F85;&#xFF08;&#x7761;&#x7720;&#xFF09;</li>
<li>&#x7B49;&#x5F85;&#x88AB;&#x5524;&#x9192;&#xFF0C;&#x53EF;&#x4EE5;&#x88AB; sources 1&#x3001;timers&#x3001;<code>CFRunLoopWakeUp</code> &#x51FD;&#x6570;&#x548C; GCD &#x4E8B;&#x4EF6;&#xFF08;&#x5982;&#x679C;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#xFF09;</li>
<li>&#x901A;&#x77E5; observers: <code>kCFRunLoopAfterWaiting</code>, &#x5373;&#x505C;&#x6B62;&#x7B49;&#x5F85;&#xFF08;&#x88AB;&#x5524;&#x9192;&#xFF09;</li>
<li>&#x88AB;&#x4EC0;&#x4E48;&#x5524;&#x9192;&#x5C31;&#x5904;&#x7406;&#x4EC0;&#x4E48;&#xFF1A;<ul>
<li>&#x88AB; timers &#x5524;&#x9192;&#xFF0C;&#x5904;&#x7406; timers&#xFF0C;&#x53EF;&#x4EE5;&#x5728; <code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__</code> &#x51FD;&#x6570;&#x4E0B;&#x65AD;&#x70B9;&#x89C2;&#x5BDF;&#x5230;</li>
<li>&#x88AB; GCD &#x5524;&#x9192;&#x6216;&#x8005;&#x4ECE;&#x7B2C; 7 &#x6B65;&#x8DF3;&#x8F6C;&#x8FC7;&#x6765;&#x7684;&#x8BDD;&#xFF0C;&#x5904;&#x7406; GCD&#xFF0C;&#x53EF;&#x4EE5;&#x5728; <code>__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</code> &#x51FD;&#x6570;&#x4E0B;&#x65AD;&#x70B9;&#x89C2;&#x5BDF;&#x5230;</li>
<li>&#x88AB; sources 1 &#x5524;&#x9192;&#xFF0C;&#x5904;&#x7406; sources 1&#xFF0C;&#x53EF;&#x4EE5;&#x5728; <code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__</code> &#x51FD;&#x6570;&#x4E0B;&#x65AD;&#x70B9;&#x89C2;&#x5BDF;&#x5230;</li>
</ul>
</li>
<li>&#x518D;&#x4E00;&#x6B21;&#x5904;&#x7406; blocks</li>
<li>&#x5224;&#x65AD;&#x662F;&#x5426;&#x9000;&#x51FA;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x9000;&#x51FA;&#x5219;&#x8DF3;&#x8F6C;&#x56DE;&#x7B2C; 2 &#x6B65;</li>
<li>&#x901A;&#x77E5; observers: <code>kCFRunLoopExit</code>, &#x9000;&#x51FA; run loop</li>
</ol>
<p>&#x6709;&#x4E00;&#x70B9;&#x51FA;&#x5165;&#x7684;&#x5730;&#x65B9;&#x662F;&#x5982;&#x679C;&#x5728;&#x7B2C; 5 &#x6B65;&#x5B9E;&#x9645;&#x5904;&#x7406;&#x4E86; sources 0&#xFF0C;&#x662F;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165;&#x7761;&#x7720;&#x7684;&#x3002;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x89C2;&#x770B;&#x4E0B;&#x9762;&#x7684;&#x6E90;&#x7801;&#x6CE8;&#x91CA;&#x3002;</p>
<h2 id="&#x5173;&#x4E8E;-apple-&#x5BF9;-run-loop-&#x7684;&#x5E94;&#x7528;">&#x5173;&#x4E8E; Apple &#x5BF9; Run Loop &#x7684;&#x5E94;&#x7528;</h2>
<p>&#x90ED;&#x66DC;&#x6E90;&#x5927;&#x795E;&#x7684;&#x6587;&#x7AE0;&#x300C;<a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank">&#x6DF1;&#x5165;&#x7406;&#x89E3;RunLoop</a>&#x300D;&#x548C;&#x5B59;&#x6E90;&#x5927;&#x795E;&#x7684;&#x89C6;&#x9891;&#x300C;<a href="http://v.youku.com/v_show/id_XODgxODkzODI0.html" target="_blank">iOS&#x7EBF;&#x4E0B;&#x5206;&#x4EAB;&#x300A;RunLoop&#x300B;by &#x5B59;&#x6E90;@sunnyxx</a>&#x300D;&#x90FD;&#x5BF9; Apple &#x5982;&#x4F55;&#x4F7F;&#x7528; run loop &#x505A;&#x4E86;&#x4ECB;&#x7ECD;&#x3002;</p>
<p>&#x4E2A;&#x4EBA;&#x63A2;&#x7D22;&#x63A8;&#x8350;&#x5BF9;&#x4E0B;&#x9762;&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#x4E0B;&#x65AD;&#x70B9;&#x8FDB;&#x884C;&#x89C2;&#x5BDF;&#xFF1A;</p>
<ol>
<li><p><code>__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</code></p>
<p> &#x8FD9;&#x662F;&#x5728; GCD &#x8C03;&#x7528;&#x524D;&#x7684;&#x5305;&#x88C5;&#x51FD;&#x6570;</p>
</li>
<li><p><code>__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</code></p>
<p> &#x8FD9;&#x662F;&#x5728; observer &#x8C03;&#x7528;&#x524D;&#x7684;&#x5305;&#x88C5;&#x51FD;&#x6570;</p>
</li>
<li><p><code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__</code></p>
<p> &#x8FD9;&#x662F;&#x5728; timer &#x8C03;&#x7528;&#x524D;&#x7684;&#x5305;&#x88C5;&#x51FD;&#x6570;</p>
</li>
<li><p><code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__</code></p>
<p> &#x8FD9;&#x662F;&#x5728; block &#x8C03;&#x7528;&#x524D;&#x7684;&#x5305;&#x88C5;&#x51FD;&#x6570;</p>
</li>
<li><p><code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</code></p>
<p> &#x8FD9;&#x662F;&#x5728; source 0 &#x8C03;&#x7528;&#x524D;&#x7684;&#x5305;&#x88C5;&#x51FD;&#x6570;</p>
</li>
<li><p><code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__</code></p>
<p> &#x8FD9;&#x662F;&#x5728; source 1 &#x8C03;&#x7528;&#x524D;&#x7684;&#x5305;&#x88C5;&#x51FD;&#x6570;</p>
</li>
</ol>
<h2 id="&#x5173;&#x4E8E;-core-foundation-&#x7684;&#x6E90;&#x7801;">&#x5173;&#x4E8E; Core Foundation &#x7684;&#x6E90;&#x7801;</h2>
<p>&#x5728; <a href="https://opensource.apple.com/" target="_blank">Apple Open Source</a> &#x53EF;&#x4EE5;&#x4E0B;&#x8F7D;&#x5230;&#x7684;&#x6700;&#x65B0; CF &#x6E90;&#x7801;&#x4E3A; 10.10.5 &#x4E0B;&#x7684; CF-1153.18&#xFF08;2017 &#x5E74; 6 &#x6708; 23 &#x65E5;&#xFF09;&#xFF0C;10.11 &#x548C; 10.12 &#x7684; CF &#x6E90;&#x7801;&#x90FD;&#x6807;&#x6CE8;&#x4E3A;&#x300C;coming soon!&#x300D;&#x3002;</p>
<p>&#x5728; Apple Open Source &#x4E0B;&#x8F7D;&#x5230;&#x7684; CF &#x6E90;&#x7801;&#x4E2D;&#x6709;&#x4E00;&#x4E2A; README_CFLITE &#x6587;&#x4EF6;&#xFF0C;&#x544A;&#x8BC9;&#x4E86;&#x6211;&#x4EEC;&#x4E00;&#x4E2A;&#x4E8B;&#x5B9E;&#xFF1A;</p>
<blockquote>
<p>What is CFLite?</p>
<p>CFLite is an open source version of the CoreFoundation framework found on Mac OS X and iOS. It is designed to be simple and portable. For example, it can be used on other platforms to read and write property lists that may come from Mac OS X or iOS.</p>
<p>It is important to note that this version is not the exact same version as is used on Mac OS X or iOS, but they do share a significant amount of code.</p>
</blockquote>
<p>&#x6240;&#x4EE5;&#x5728; <a href="https://opensource.apple.com/" target="_blank">Apple Open Source</a> &#x4E0B;&#x8F7D;&#x5230;&#x7684;&#x5176;&#x5B9E;&#x662F; CFLite&#xFF0C;&#x662F;&#x5F00;&#x6E90;&#x7248;&#x7684; Core Foundation&#xFF0C;&#x548C;&#x7CFB;&#x7EDF;&#x4E2D;&#x5E26;&#x7684;&#x5E76;&#x4E0D;&#x662F;&#x5B8C;&#x5168;&#x4E00;&#x6A21;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x73B0;&#x5728;&#x8FD8;&#x6709;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#xFF0C;&#x5C31;&#x662F;&#x4F7F;&#x7528; Swift &#x5B9E;&#x73B0;&#x7684; Foundation &#x6846;&#x67B6;&#xFF0C;&#x5F00;&#x6E90;&#x5728; GitHub: <a href="https://github.com/apple/swift-corelibs-foundation" target="_blank">swift-corelibs-foundation</a>, &#x5176;&#x4E2D;&#x4E5F;&#x5305;&#x542B;&#x4E86; Core Foundation&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x8FD9;&#x4E2A;&#x7248;&#x672C;&#x80AF;&#x5B9A;&#x8DDF;&#x7CFB;&#x7EDF;&#x91CC;&#x7684;&#x7248;&#x672C;&#x4E5F;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<p>&#x6211;&#x731C;&#x6D4B;&#x8FD9;&#x91CC;&#x7684; Core Foundation &#x7248;&#x672C;&#x548C; Apple Open Source &#x8FD9;&#x4E2A;&#x7F51;&#x7AD9;&#x7684;&#x7248;&#x672C;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x66F4;&#x65B0;&#xFF0C;&#x6BD4;&#x5982;&#x6700;&#x8FD1;&#x7684; commit&#xFF1A;&#x300C;Import CoreFoundation changes from Sierra&#x300D;&#xFF0C;&#x8868;&#x660E;&#x5DF2;&#x7ECF;&#x662F; Sierra &#x7684;&#x7248;&#x672C;&#x4E86;&#x3002;</p>
<p>&#x672C;&#x6587;&#x4F7F;&#x7528;&#x7684;&#x6E90;&#x7801;&#x662F; <a href="https://github.com/apple/swift-corelibs-foundation" target="_blank">swift-corelibs-foundation</a> master &#x5206;&#x652F;&#x4E0A;&#x7684;&#x7248;&#x672C;&#x3002;</p>
<h2 id="&#x6E90;&#x7801;&#x6CE8;&#x91CA;">&#x6E90;&#x7801;&#x6CE8;&#x91CA;</h2>
<h3 id="&#x6570;&#x636E;&#x7ED3;&#x6784;">&#x6570;&#x636E;&#x7ED3;&#x6784;</h3>
<h4 id="run-loop">Run Loop</h4>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title">CF_BRIDGED_MUTABLE_TYPE</span><span class="hljs-params">(id)</span> __CFRunLoop * CFRunLoopRef</span>;

<span class="hljs-keyword">struct</span> __CFRunLoop {
    CFRuntimeBase _base;
    <span class="hljs-keyword">pthread_mutex_t</span> _lock;            <span class="hljs-comment">/* locked for accessing mode list */</span>
    __CFPort _wakeUpPort;            <span class="hljs-comment">// used for CFRunLoopWakeUp </span>
    Boolean _unused;
    <span class="hljs-keyword">volatile</span> _per_run_data *_perRunData;              <span class="hljs-comment">// reset for runs of the run loop</span>
    <span class="hljs-keyword">pthread_t</span> _pthread;
    <span class="hljs-keyword">uint32_t</span> _winthread;
    CFMutableSetRef _commonModes;
    CFMutableSetRef _commonModeItems;
    CFRunLoopModeRef _currentMode;
    CFMutableSetRef _modes;
    <span class="hljs-keyword">struct</span> _block_item *_blocks_head;
    <span class="hljs-keyword">struct</span> _block_item *_blocks_tail;
    CFAbsoluteTime _runTime;
    CFAbsoluteTime _sleepTime;
    CFTypeRef _counterpart;
};
</code></pre>
<table>
<thead>
<tr>
<th>&#x7C7B;&#x578B;</th>
<th>&#x53D8;&#x91CF;&#x540D;</th>
<th>&#x7528;&#x5904;</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CFRuntimeBase</code></td>
<td><code>_base</code></td>
<td>&#x5E94;&#x8BE5;&#x662F; Core Foundation &#x5BF9;&#x8C61;&#x90FD;&#x9700;&#x8981;&#x7684;&#x4E1C;&#x897F;</td>
</tr>
<tr>
<td><code>pthread_mutex_t</code></td>
<td><code>_lock</code></td>
<td>&#x4E00;&#x4E2A; mutex&#xFF0C;&#x6839;&#x636E;&#x6CE8;&#x91CA;&#xFF0C;&#x662F;&#x7528;&#x6765;&#x9501;&#x5BF9;&#x4E8E; mode &#x7684;&#x8BBF;&#x95EE;&#x7684;&#x3002;&#x5BF9;&#x5176;&#x64CD;&#x4F5C;&#x7531; <code>__CFRunLoopLockInit</code>&#x3001;<code>__CFRunLoopLock</code> &#x548C; <code>__CFRunLoopUnlock</code> &#x51FD;&#x6570;&#x5C01;&#x88C5;</td>
</tr>
<tr>
<td><code>__CFPort</code></td>
<td><code>_wakeUpPort</code></td>
<td><code>__CFPort</code> &#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F; <code>mach_port_t</code>&#x3002;&#x6839;&#x636E;&#x6CE8;&#x91CA;&#xFF0C;&#x8FD9;&#x662F;&#x7528;&#x6765;&#x5524;&#x9192; run loop &#x7684; mach port&#xFF0C;&#x88AB; <code>CFRunLoopWakeUp</code> &#x51FD;&#x6570;&#x4F7F;&#x7528;</td>
</tr>
<tr>
<td><code>Boolean</code></td>
<td><code>_unused</code></td>
<td>&#x548C;&#x53D8;&#x91CF;&#x540D;&#x4E00;&#x6837;&#xFF0C;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x731C;&#x6D4B;&#x662F;&#x4E3A;&#x4E86;&#x5BF9;&#x9F50;&#x7528;&#xFF1F;</td>
</tr>
<tr>
<td><code>_per_run_data *</code></td>
<td><code>_perRunData</code></td>
<td>&#x6BCF;&#x6B21;&#x8C03;&#x7528; <code>CFRunLoopRun</code> &#x6216;&#x8005; <code>CFRunLoopRunInMode</code> &#x51FD;&#x6570;&#xFF08;&#x5B9E;&#x9645;&#x5C31;&#x662F;&#x5BF9; <code>CFRunLoopRunSpecific</code> &#x51FD;&#x6570;&#x7684;&#x8C03;&#x7528;&#xFF09;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6BCF;&#x6B21; run &#x7684;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x6570;&#x636E;&#x3002;&#x76F8;&#x5173;&#x64CD;&#x4F5C;&#xFF1A;<code>__CFRunLoopPushPerRunData</code> &#x548C; <code>__CFRunLoopPopPerRunData</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x53C8; push &#x53C8; pop &#x7684;&#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A; run loop &#x53EF;&#x4EE5;&#x5D4C;&#x5957;&#x8C03;&#x7528;</td>
</tr>
<tr>
<td><code>pthread_t</code></td>
<td><code>_pthread</code></td>
<td>&#x5BF9;&#x5E94;&#x7684; pthread</td>
</tr>
<tr>
<td><code>uint32_t</code></td>
<td><code>_winthread</code></td>
<td>Windows &#x4E0B;&#x5BF9;&#x5E94;&#x7EBF;&#x7A0B;</td>
</tr>
<tr>
<td><code>CFMutableSetRef</code></td>
<td><code>_commonModes</code></td>
<td>&#x5B58;&#x653E; common mode &#x7684;&#x96C6;&#x5408;</td>
</tr>
<tr>
<td><code>CFMutableSetRef</code></td>
<td><code>_commonModeItems</code></td>
<td>&#x6BCF;&#x4E2A; common mode &#x90FD;&#x6709;&#x7684; item (source, timer and observer) &#x96C6;&#x5408;</td>
</tr>
<tr>
<td><code>CFRunLoopModeRef</code></td>
<td><code>_currentMode</code></td>
<td>&#x5F53;&#x524D; run &#x7684; mode</td>
</tr>
<tr>
<td><code>CFMutableSetRef</code></td>
<td><code>_modes</code></td>
<td>&#x8FD9;&#x4E2A; run loop &#x6240;&#x6709;&#x7684; mode &#x96C6;&#x5408;</td>
</tr>
<tr>
<td><code>sturct _block_item *</code></td>
<td><code>_blocks_head</code></td>
<td>&#x5B58;&#x653E; <code>CFRunLoopPerformBlock</code> &#x51FD;&#x6570;&#x6DFB;&#x52A0;&#x7684; block &#x7684;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x5934;&#x6307;&#x9488;</td>
</tr>
<tr>
<td><code>sturct _block_item *</code></td>
<td><code>_blocks_tail</code></td>
<td>&#x540C;&#x4E0A;&#x5C3E;&#x8102;&#x9488;</td>
</tr>
<tr>
<td><code>CFAbsoluteTime</code></td>
<td><code>_runTime</code></td>
<td>&#x4F30;&#x8BA1;&#x662F;&#x4E00;&#x5171;&#x8DD1;&#x7740;&#x7684;&#x65F6;&#x95F4;&#xFF08;&#x4F46;&#x5B9E;&#x9645;&#x4E0A;&#x6839;&#x672C;&#x6CA1;&#x4F7F;&#x7528;&#xFF09;</td>
</tr>
<tr>
<td><code>CFAbsoluteTime</code></td>
<td><code>_sleepTime</code></td>
<td>&#x4E00;&#x5171;&#x7761;&#x4E86;&#x591A;&#x4E45;</td>
</tr>
<tr>
<td><code>CFTypeRef</code></td>
<td><code>_counterpart</code></td>
<td>&#x7ED9; Swift &#x7528;&#x7684;&#x73A9;&#x610F;</td>
</tr>
</tbody>
</table>
<h4 id="run-loop-mode">Run Loop Mode</h4>
<pre><code class="lang-c"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> __CFRunLoopMode *CFRunLoopModeRef;

<span class="hljs-keyword">struct</span> __CFRunLoopMode {
    CFRuntimeBase _base;
    <span class="hljs-keyword">pthread_mutex_t</span> _lock;    <span class="hljs-comment">/* must have the run loop locked before locking this */</span>
    CFStringRef _name;
    Boolean _stopped;
    <span class="hljs-keyword">char</span> _padding[<span class="hljs-number">3</span>];
    CFMutableSetRef _sources0;
    CFMutableSetRef _sources1;
    CFMutableArrayRef _observers;
    CFMutableArrayRef _timers;
    CFMutableDictionaryRef _portToV1SourceMap;
    __CFPortSet _portSet;
    CFIndex _observerMask;
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span>
    <span class="hljs-keyword">dispatch_source_t</span> _timerSource;
    <span class="hljs-keyword">dispatch_queue_t</span> _queue;
    Boolean _timerFired; <span class="hljs-comment">// set to true by the source when a timer has fired</span>
    Boolean _dispatchTimerArmed;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_MK_TIMER_TOO</span>
    __CFPort _timerPort;
    Boolean _mkTimerArmed;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEPLOYMENT_TARGET_WINDOWS</span>
    DWORD _msgQMask;
    <span class="hljs-keyword">void</span> (*_msgPump)(<span class="hljs-keyword">void</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
    <span class="hljs-keyword">uint64_t</span> _timerSoftDeadline; <span class="hljs-comment">/* TSR */</span>
    <span class="hljs-keyword">uint64_t</span> _timerHardDeadline; <span class="hljs-comment">/* TSR */</span>
};
</code></pre>
<p><code>USE_DISPATCH_SOURCE_FOR_TIMERS</code> &#x8FD9;&#x4E2A;&#x5B8F;&#x7684;&#x503C;&#x4E3A; 1&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6709;&#x4F7F;&#x7528; GCD &#x6765;&#x5B9E;&#x73B0; timer&#xFF0C;&#x5F53;&#x7136; <code>USE_MK_TIMER_TOO</code> &#x8FD9;&#x4E2A;&#x5B8F;&#x7684;&#x503C;&#x4E5F;&#x662F; 1&#xFF0C;&#x8868;&#x793A;<strong>&#x4E5F;</strong>&#x4F7F;&#x7528;&#x4E86;&#x66F4;&#x5E95;&#x5C42;&#x7684; timer&#x3002;</p>
<table>
<thead>
<tr>
<th>&#x7C7B;&#x578B;</th>
<th>&#x53D8;&#x91CF;&#x540D;</th>
<th>&#x7528;&#x5904;</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CFRuntimeBase</code></td>
<td><code>_base</code></td>
<td>&#x5E94;&#x8BE5;&#x662F; Core Foundation &#x5BF9;&#x8C61;&#x90FD;&#x9700;&#x8981;&#x7684;&#x4E1C;&#x897F;</td>
</tr>
<tr>
<td><code>pthread_mutex_t</code></td>
<td><code>_lock</code></td>
<td>&#x4E00;&#x4E2A; mutex&#xFF0C;&#x9501; mode &#x91CC;&#x7684;&#x5404;&#x79CD;&#x64CD;&#x4F5C;&#x3002;&#x6839;&#x636E;&#x6CE8;&#x91CA;&#xFF0C;&#x9700;&#x8981; run loop &#x7684;&#x9501;&#x5148;&#x9501;&#x4E0A;&#x624D;&#x80FD;&#x9501;&#x8FD9;&#x4E2A;&#x9501;&#x3002;&#x540C;&#x6837;&#x4E5F;&#x6709;&#x4E24;&#x4E2A;&#x51FD;&#x6570; <code>__CFRunLoopModeLock</code> &#x548C; <code>__CFRunLoopModeUnlock</code> &#x5BF9;&#x5176;&#x64CD;&#x4F5C;&#x8FDB;&#x884C;&#x4E86;&#x7B80;&#x5355;&#x5C01;&#x88C5;</td>
</tr>
<tr>
<td><code>CFStringRef</code></td>
<td><code>_name</code></td>
<td>&#x5F53;&#x7136;&#x662F;&#x540D;&#x5B57;&#x5566;</td>
</tr>
<tr>
<td><code>Boolean</code></td>
<td><code>_stopped</code></td>
<td>&#x662F;&#x5426;&#x505C;&#x6B62;&#x4E86;</td>
</tr>
<tr>
<td><code>char[3]</code></td>
<td><code>_padding</code></td>
<td>&#x53EF;&#x80FD;&#x662F;&#x4E3A;&#x4E86;&#x5BF9;&#x9F50;&#x7528;&#x7684;&#x5427;&#x2026;&#x2026;</td>
</tr>
<tr>
<td><code>CFMutableSetRef</code></td>
<td><code>_sources0</code></td>
<td>Source0 &#x96C6;&#x5408;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x975E; port &#x7684; source</td>
</tr>
<tr>
<td><code>CFMutableSetRef</code></td>
<td><code>_sources1</code></td>
<td>Source1 &#x96C6;&#x5408;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x57FA;&#x4E8E; port &#x7684; source</td>
</tr>
<tr>
<td><code>CFMutableArrayRef</code></td>
<td><code>_observers</code></td>
<td>Observer &#x96C6;&#x5408;</td>
</tr>
<tr>
<td><code>CFMutableArrayRef</code></td>
<td><code>_timers</code></td>
<td>Timer &#x96C6;&#x5408;</td>
</tr>
<tr>
<td><code>CFMutableDictionaryRef</code></td>
<td><code>_portToV1SourceMap</code></td>
<td>Key &#x662F; port&#xFF0C;value &#x662F;&#x5BF9;&#x5E94; source1 &#x7684;&#x5B57;&#x5178;</td>
</tr>
<tr>
<td><code>__CFPortSet</code></td>
<td><code>_portSet</code></td>
<td>&#x6240;&#x6709; port &#x7684;&#x96C6;&#x5408;</td>
</tr>
<tr>
<td><code>CFIndex</code></td>
<td><code>_observerMask</code></td>
<td>&#x9700;&#x8981; observe &#x7684;&#x4E8B;&#x4EF6;&#x7684; mask&#xFF0C;&#x4E00;&#x4E2A;&#x5C0F;&#x4F18;&#x5316;</td>
</tr>
<tr>
<td><code>dispatch_source_t</code></td>
<td><code>_timerSource</code></td>
<td>&#x7528;&#x6765;&#x5B9E;&#x73B0; timer &#x7684; GCD timer</td>
</tr>
<tr>
<td><code>dispatch_queue_t</code></td>
<td><code>_queue</code></td>
<td>&#x653E; <code>_timerSource</code> &#x7684;&#x961F;&#x5217;</td>
</tr>
<tr>
<td><code>Boolean</code></td>
<td><code>_timerFired</code></td>
<td><code>_timerSource</code> &#x662F;&#x5426;&#x88AB;&#x542F;&#x52A8;</td>
</tr>
<tr>
<td><code>Boolean</code></td>
<td><code>_dispatchTimerArmed</code></td>
<td>timer &#x662F;&#x5426;&#x88AB;&#x5B89;&#x88C5;&#x4E0A;&#x4E86;&#xFF0C;&#x6216;&#x8005;&#x8BF4;&#x662F;&#x5426;&#x5F00;&#x542F;&#x4E86;</td>
</tr>
<tr>
<td><code>__CFPort</code></td>
<td><code>_timerPort</code></td>
<td>&#x4F7F;&#x7528; MK timer &#x65F6;&#x7684;&#x7AEF;&#x53E3;</td>
</tr>
<tr>
<td><code>Boolean</code></td>
<td><code>_mkTimerArmed</code></td>
<td>timer &#x662F;&#x5426;&#x88AB;&#x5F00;&#x542F;</td>
</tr>
<tr>
<td><code>uint64_t</code></td>
<td><code>_timerSoftDeadline</code></td>
<td>&#x4E0B;&#x4E00;&#x4E2A;&#x8BA1;&#x5212;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x95F4;</td>
</tr>
<tr>
<td><code>uint64_t</code></td>
<td><code>_timerHardDeadline</code></td>
<td>&#x4E0B;&#x4E00;&#x4E2A;&#x6700;&#x8FDF;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x95F4;&#xFF08;&#x8BA1;&#x5212;&#x52A0;&#x4E0A;&#x5BB9;&#x5FCD;&#x5EF6;&#x8FDF;&#x7684;&#x65F6;&#x95F4;&#xFF09;</td>
</tr>
</tbody>
</table>
<h3 id="&#x8FD0;&#x884C;&#x51FD;&#x6570;">&#x8FD0;&#x884C;&#x51FD;&#x6570;</h3>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CFRunLoopRun</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{    <span class="hljs-comment">/* DOES CALLOUT */</span>
    <span class="hljs-keyword">int32_t</span> result;
    <span class="hljs-keyword">do</span> {
        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), 
                                      kCFRunLoopDefaultMode, 
                                      <span class="hljs-number">1.0e10</span>, 
                                      <span class="hljs-literal">false</span>);
        CHECK_FOR_FORK();
    } <span class="hljs-keyword">while</span> (kCFRunLoopRunStopped != result 
             &amp;&amp; kCFRunLoopRunFinished != result);
}

<span class="hljs-function">SInt32 
<span class="hljs-title">CFRunLoopRunInMode</span><span class="hljs-params">(CFStringRef modeName, 
                   CFTimeInterval seconds, 
                   Boolean returnAfterSourceHandled)</span> </span>{     <span class="hljs-comment">/* DOES CALLOUT */</span>
    CHECK_FOR_FORK();
    <span class="hljs-keyword">return</span> CFRunLoopRunSpecific(CFRunLoopGetCurrent(), 
                                modeName, 
                                seconds, 
                                returnAfterSourceHandled);
}
</code></pre>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230; <code>CFRunLoopRun</code> &#x51FD;&#x6570;&#x4E0D;&#x4E3B;&#x52A8;&#x8C03;&#x7528; <code>CFRunLoopStop</code> &#x51FD;&#x6570;&#xFF08;<code>kCFRunLoopRunStopped</code> &#x7684;&#x60C5;&#x51B5;&#xFF09;&#x6216;&#x8005;&#x5C06;&#x6240;&#x6709;&#x4E8B;&#x4EF6;&#x6E90;&#x79FB;&#x9664;&#xFF08;<code>kCFRunLoopRunFinished</code> &#x7684;&#x60C5;&#x51B5;&#xFF09;&#x662F;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x9000;&#x51FA;&#x7684;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-function">SInt32 
<span class="hljs-title">CFRunLoopRunSpecific</span><span class="hljs-params">(CFRunLoopRef rl, 
                     CFStringRef modeName, 
                     CFTimeInterval seconds, 
                     Boolean returnAfterSourceHandled)</span> </span>{     <span class="hljs-comment">/* DOES CALLOUT */</span>
    CHECK_FOR_FORK();
    <span class="hljs-comment">//// &#x68C0;&#x67E5; mode &#x662F;&#x5426;&#x5408;&#x6CD5;</span>
    <span class="hljs-keyword">if</span> (modeName == <span class="hljs-literal">NULL</span> || modeName == kCFRunLoopCommonModes || CFEqual(modeName, kCFRunLoopCommonModes)) {
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">dispatch_once_t</span> onceToken;
        dispatch_once(&amp;onceToken, ^{
            CFLog(kCFLogLevelError, CFSTR(<span class="hljs-string">&quot;invalid mode &apos;%@&apos; provided to CFRunLoopRunSpecific - break on _CFRunLoopError_RunCalledWithInvalidMode to debug. This message will only appear once per execution.&quot;</span>), modeName);
            _CFRunLoopError_RunCalledWithInvalidMode();
        });
        <span class="hljs-keyword">return</span> kCFRunLoopRunFinished;
    }
    <span class="hljs-comment">//// &#x68C0;&#x67E5; run loop &#x662F;&#x5426;&#x6B63;&#x5728;&#x9500;&#x6BC1;</span>
    <span class="hljs-keyword">if</span> (__CFRunLoopIsDeallocating(rl)) <span class="hljs-keyword">return</span> kCFRunLoopRunFinished;
    __CFRunLoopLock(rl);
    <span class="hljs-comment">//// &#x67E5;&#x627E; modeName &#x6307;&#x5B9A;&#x7684; mode</span>
    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, <span class="hljs-literal">false</span>);
    <span class="hljs-comment">//// &#x6CA1;&#x6709;&#x627E;&#x5230; mode &#x6216;&#x8005; mode &#x91CC;&#x9762;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x4E8B;&#x4EF6;&#x6E90;&#x7684;&#x8BDD;&#xFF0C;&#x8FD4;&#x56DE; kCFRunLoopRunFinished</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == currentMode || __CFRunLoopModeIsEmpty(rl, currentMode, rl-&gt;_currentMode)) {
        <span class="hljs-comment">//// &#x4E0D;&#x80FD;&#x7406;&#x89E3;&#x8FD9;&#x4E2A; did &#x6709;&#x4EC0;&#x4E48;&#x7528;&#x2026;&#x2026;</span>
        Boolean did = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (currentMode) __CFRunLoopModeUnlock(currentMode);
        __CFRunLoopUnlock(rl);
        <span class="hljs-keyword">return</span> did ? kCFRunLoopRunHandledSource : kCFRunLoopRunFinished;
    }
    <span class="hljs-comment">//// &#x56E0;&#x4E3A;&#x53EF;&#x4EE5;&#x5D4C;&#x5957;&#x8C03;&#x7528;&#xFF0C;&#x4FDD;&#x5B58;&#x4E00;&#x4E0B;&#x4E4B;&#x524D;&#x7684;&#x72B6;&#x6001;</span>
    <span class="hljs-keyword">volatile</span> _per_run_data *previousPerRun = __CFRunLoopPushPerRunData(rl);
    CFRunLoopModeRef previousMode = rl-&gt;_currentMode;
    <span class="hljs-comment">//// &#x521D;&#x59CB;&#x5316;&#x5F53;&#x524D;&#x8C03;&#x7528;&#x7684;&#x72B6;&#x6001;</span>
    rl-&gt;_currentMode = currentMode;
    <span class="hljs-keyword">int32_t</span> result = kCFRunLoopRunFinished;

    <span class="hljs-comment">//// 1. &#x901A;&#x77E5; observers: kCFRunLoopEntry, &#x8FDB;&#x5165; run loop</span>
    <span class="hljs-keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);
    result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);
    <span class="hljs-comment">//// 14. &#x901A;&#x77E5; observers: `kCFRunLoopExit`, &#x9000;&#x51FA; run loop</span>
    <span class="hljs-keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopExit ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);

    <span class="hljs-comment">//// &#x6062;&#x590D;&#x4E4B;&#x524D;&#x7684;&#x72B6;&#x6001;</span>
    __CFRunLoopModeUnlock(currentMode);
    __CFRunLoopPopPerRunData(rl, previousPerRun);
    rl-&gt;_currentMode = previousMode;
    __CFRunLoopUnlock(rl);
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x5220;&#x9664;&#x4E86;&#x5173;&#x4E8E; Windows &#x548C; Linux &#x7684;&#x6E90;&#x7801;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">/* rl, rlm are locked on entrance and exit */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">int32_t</span>
__CFRunLoopRun(CFRunLoopRef rl,
               CFRunLoopModeRef rlm,
               CFTimeInterval seconds,
               Boolean stopAfterHandle,
               CFRunLoopModeRef previousMode)
{
    <span class="hljs-comment">//// &#x8BB0;&#x5F55;&#x5F00;&#x59CB;&#x65F6;&#x95F4;</span>
    <span class="hljs-keyword">uint64_t</span> startTSR = mach_absolute_time();

    <span class="hljs-comment">//// &#x68C0;&#x67E5;&#x662F;&#x5426;&#x88AB;&#x505C;&#x6B62;</span>
    <span class="hljs-keyword">if</span> (__CFRunLoopIsStopped(rl)) {
        __CFRunLoopUnsetStopped(rl);
        <span class="hljs-keyword">return</span> kCFRunLoopRunStopped;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rlm-&gt;_stopped) {
        rlm-&gt;_stopped = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> kCFRunLoopRunStopped;
    }

    <span class="hljs-comment">//// &#x5982;&#x679C;&#x4F7F;&#x7528;&#x4E86; GCD &#x7684;&#x8BDD;&#xFF0C;&#x83B7;&#x53D6; GCD &#x6D88;&#x606F;&#x7AEF;&#x53E3;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __HAS_DISPATCH__</span>
    <span class="hljs-comment">//// GCD &#x7AEF;&#x53E3;&#x5B58;&#x653E;&#x53D8;&#x91CF;</span>
    __CFPort dispatchPort = CFPORT_NULL;
    <span class="hljs-comment">//// &#x68C0;&#x67E5;&#x662F;&#x5426;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#xFF08;&#x548C;&#x662F;&#x5426;&#x5141;&#x8BB8;&#x5D4C;&#x5957;&#x8C03;&#x7528;&#x7684; run loop &#x5904;&#x7406; GCD&#xFF09;</span>
    Boolean libdispatchQSafe =
    pthread_main_np()
    &amp;&amp; ((HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; <span class="hljs-literal">NULL</span> == previousMode)
        || (!HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; <span class="hljs-number">0</span> == _CFGetTSD(__CFTSDKeyIsInGCDMainQ)));
    <span class="hljs-comment">//// &#x9700;&#x8981;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#xFF0C;run loop &#x4E5F;&#x662F;&#x4E3B;&#x7EBF;&#x7A0B;&#x7684; run loop&#xFF0C;&#x5E76;&#x4E14; mode &#x662F; common mode</span>
    <span class="hljs-keyword">if</span> (libdispatchQSafe
        &amp;&amp; (CFRunLoopGetMain() == rl)
        &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name))
        <span class="hljs-comment">//// &#x4ECE; GCD &#x7684;&#x79C1;&#x6709; API &#x83B7;&#x53D6;&#x7AEF;&#x53E3;&#xFF08;4CF &#x8868;&#x793A; for Core Foundation&#xFF09;</span>
        dispatchPort = _dispatch_get_main_queue_port_4CF();
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

    <span class="hljs-comment">//// &#x5982;&#x679C;&#x4F7F;&#x7528; GCD timer &#x4F5C;&#x4E3A; timer &#x7684;&#x5B9E;&#x73B0;&#x7684;&#x8BDD;&#xFF0C;&#x8FDB;&#x884C;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span>
    <span class="hljs-keyword">mach_port_name_t</span> modeQueuePort = MACH_PORT_NULL;
    <span class="hljs-keyword">if</span> (rlm-&gt;_queue) {
        modeQueuePort = _dispatch_runloop_root_queue_get_port_4CF(rlm-&gt;_queue);
        <span class="hljs-keyword">if</span> (!modeQueuePort) {
            CRASH(<span class="hljs-string">&quot;Unable to get port for run loop mode queue (%d)&quot;</span>, <span class="hljs-number">-1</span>);
        }
    }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

    <span class="hljs-comment">//// &#x8BBE;&#x7F6E;&#x8D85;&#x65F6;&#x7684;&#x73A9;&#x610F;&#x5F00;&#x59CB;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __HAS_DISPATCH__</span>
    <span class="hljs-keyword">dispatch_source_t</span> timeout_timer = <span class="hljs-literal">NULL</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
    <span class="hljs-keyword">struct</span> __timeout_context *timeout_context = (<span class="hljs-keyword">struct</span> __timeout_context *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(*timeout_context));
    <span class="hljs-keyword">if</span> (seconds &lt;= <span class="hljs-number">0.0</span>) { <span class="hljs-comment">// instant timeout</span>
        seconds = <span class="hljs-number">0.0</span>;
        timeout_context-&gt;termTSR = <span class="hljs-number">0U</span>LL;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (seconds &lt;= TIMER_INTERVAL_LIMIT) {
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __HAS_DISPATCH__</span>
        <span class="hljs-keyword">dispatch_queue_t</span> <span class="hljs-built_in">queue</span> = 
        pthread_main_np() 
        ? __CFDispatchQueueGetGenericMatchingMain() 
        : __CFDispatchQueueGetGenericBackground();
        timeout_timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 
                                               <span class="hljs-number">0</span>, 
                                               <span class="hljs-number">0</span>, 
                                               <span class="hljs-built_in">queue</span>);
        dispatch_retain(timeout_timer);
        timeout_context-&gt;ds = timeout_timer;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
        timeout_context-&gt;rl = (CFRunLoopRef)CFRetain(rl);
        timeout_context-&gt;termTSR = startTSR + __CFTimeIntervalToTSR(seconds);
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __HAS_DISPATCH__</span>
        dispatch_set_context(timeout_timer, timeout_context); <span class="hljs-comment">// source gets ownership of context</span>
        dispatch_source_set_event_handler_f(timeout_timer, __CFRunLoopTimeout);
        dispatch_source_set_cancel_handler_f(timeout_timer, __CFRunLoopTimeoutCancel);
        <span class="hljs-keyword">uint64_t</span> ns_at = (<span class="hljs-keyword">uint64_t</span>)((__CFTSRToTimeInterval(startTSR) + seconds) * <span class="hljs-number">1000000000U</span>LL);
        dispatch_source_set_timer(timeout_timer, dispatch_time(<span class="hljs-number">1</span>, ns_at), DISPATCH_TIME_FOREVER, <span class="hljs-number">1000U</span>LL);
        dispatch_resume(timeout_timer);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// infinite timeout</span>
        seconds = <span class="hljs-number">9999999999.0</span>;
        timeout_context-&gt;termTSR = UINT64_MAX;
    }
    <span class="hljs-comment">//// &#x8BBE;&#x7F6E;&#x8D85;&#x65F6;&#x7684;&#x73A9;&#x610F;&#x7ED3;&#x675F;</span>

    Boolean didDispatchPortLastTime = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">int32_t</span> retVal = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">voucher_mach_msg_state_t</span> voucherState = VOUCHER_MACH_MSG_STATE_UNCHANGED;
        <span class="hljs-keyword">voucher_t</span> voucherCopy = <span class="hljs-literal">NULL</span>;

        <span class="hljs-keyword">uint8_t</span> msg_buffer[<span class="hljs-number">3</span> * <span class="hljs-number">1024</span>];

        <span class="hljs-keyword">mach_msg_header_t</span> *msg = <span class="hljs-literal">NULL</span>;
        <span class="hljs-keyword">mach_port_t</span> livePort = MACH_PORT_NULL;

        __CFPortSet waitSet = rlm-&gt;_portSet;

        __CFRunLoopUnsetIgnoreWakeUps(rl);

        <span class="hljs-comment">//// 2. &#x901A;&#x77E5; observers: kCFRunLoopBeforeTimers, &#x5373;&#x5C06;&#x5904;&#x7406; timers</span>
        <span class="hljs-keyword">if</span> (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);
        <span class="hljs-comment">//// 3. &#x901A;&#x77E5; observers: kCFRunLoopBeforeSources, &#x5373;&#x5C06;&#x5904;&#x7406; sources</span>
        <span class="hljs-keyword">if</span> (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);

        <span class="hljs-comment">//// 4. &#x5904;&#x7406; blocks</span>
        __CFRunLoopDoBlocks(rl, rlm);

        <span class="hljs-comment">//// 5. &#x5904;&#x7406; sources 0</span>
        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);
        <span class="hljs-comment">//// 6. &#x5982;&#x679C;&#x7B2C; 5 &#x6B65;&#x5B9E;&#x9645;&#x5904;&#x7406;&#x4E86; sources 0&#xFF0C;&#x518D;&#x4E00;&#x6B21;&#x5904;&#x7406; blocks</span>
        <span class="hljs-keyword">if</span> (sourceHandledThisLoop) {
            __CFRunLoopDoBlocks(rl, rlm);
        }

        <span class="hljs-comment">//// &#x662F;&#x5426;&#x5904;&#x7406;&#x8FC7; source &#x6216;&#x8D85;&#x65F6;</span>
        Boolean poll = sourceHandledThisLoop 
                       || (<span class="hljs-number">0U</span>LL == timeout_context-&gt;termTSR);

        <span class="hljs-comment">//// 7. &#x5982;&#x679C;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#xFF0C;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709; GCD &#x4E8B;&#x4EF6;&#x9700;&#x8981;&#x5904;&#x7406;&#xFF0C;&#x6709;&#x7684;&#x8BDD;&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;&#x7B2C; 11 &#x6B65;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __HAS_DISPATCH__</span>
        <span class="hljs-keyword">if</span> (MACH_PORT_NULL != dispatchPort 
            &amp;&amp; !didDispatchPortLastTime) {
            msg = (<span class="hljs-keyword">mach_msg_header_t</span> *)msg_buffer;
            <span class="hljs-comment">//// __CFRunLoopServiceMachPort &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4F1A;&#x7761;&#x7720;&#x7EBF;&#x7A0B;&#xFF0C;&#x5982;&#x679C;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x4E0D;&#x4E3A; 0 &#x7684;&#x8BDD;</span>
            <span class="hljs-keyword">if</span> (__CFRunLoopServiceMachPort(dispatchPort,       <span class="hljs-comment">// &#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3; </span>
                                           &amp;msg,               <span class="hljs-comment">// &#x5B58;&#x653E;&#x6D88;&#x606F;&#x7684;&#x5730;&#x5740;</span>
                                           <span class="hljs-keyword">sizeof</span>(msg_buffer),
                                           &amp;livePort,          <span class="hljs-comment">// &#x8FD4;&#x56DE;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x7684;&#x7AEF;&#x53E3;</span>
                                           <span class="hljs-number">0</span>,                  <span class="hljs-comment">// &#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF0C;&#x8FD9;&#x91CC;&#x4E3A; 0 &#x8868;&#x793A;&#x4E0D;&#x4F1A;&#x7761;&#x7720; </span>
                                           &amp;voucherState, 
                                           <span class="hljs-literal">NULL</span>)) {
                <span class="hljs-keyword">goto</span> handle_msg;
            }
        }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

        didDispatchPortLastTime = <span class="hljs-literal">false</span>;

        <span class="hljs-comment">//// 8. &#x901A;&#x77E5; observers: kCFRunLoopBeforeWaiting, &#x5373;&#x5C06;&#x8FDB;&#x5165;&#x7B49;&#x5F85;&#xFF08;&#x7761;&#x7720;&#xFF09;</span>
        <span class="hljs-comment">//// &#x6CE8;&#x610F;&#x5230;&#x5982;&#x679C;&#x5B9E;&#x9645;&#x5904;&#x7406;&#x4E86; source 0 &#x6216;&#x8005;&#x8D85;&#x65F6;&#x4E86;&#xFF0C;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165;&#x7761;&#x7720;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x4F1A;&#x901A;&#x77E5;</span>
        <span class="hljs-keyword">if</span> (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);
        <span class="hljs-comment">//// &#x8BBE;&#x7F6E;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x6B63;&#x5728;&#x7761;&#x7720;&#xFF08;&#x5B9E;&#x9645;&#x4E0A;&#x6CA1;&#x6709;&#x5F00;&#x59CB;&#x7761;&#xFF09;</span>
        __CFRunLoopSetSleeping(rl);
        <span class="hljs-comment">// do not do any user callouts after this point (after notifying of sleeping)</span>

        <span class="hljs-comment">// Must push the local-to-this-activation ports in on every loop</span>
        <span class="hljs-comment">// iteration, as this mode could be run re-entrantly and we don&apos;t</span>
        <span class="hljs-comment">// want these ports to get serviced.</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __HAS_DISPATCH__</span>
        <span class="hljs-comment">//// &#x4F7F;&#x7528; GCD &#x7684;&#x8BDD;&#xFF0C;&#x5C06; GCD &#x7AEF;&#x53E3;&#x52A0;&#x5165;&#x6240;&#x6709;&#x76D1;&#x542C;&#x7AEF;&#x53E3;&#x96C6;&#x5408;&#x4E2D;</span>
        __CFPortSetInsert(dispatchPort, waitSet);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

        __CFRunLoopModeUnlock(rlm);
        __CFRunLoopUnlock(rl);

        <span class="hljs-comment">//// &#x8BB0;&#x5F55;&#x7761;&#x7720;&#x5F00;&#x59CB;&#x65F6;&#x95F4;</span>
        CFAbsoluteTime sleepStart = poll ? <span class="hljs-number">0.0</span> : CFAbsoluteTimeGetCurrent();

        <span class="hljs-comment">//// 9. &#x7B49;&#x5F85;&#x88AB;&#x5524;&#x9192;&#xFF0C;&#x53EF;&#x4EE5;&#x88AB; sources 1&#x3001;timers&#x3001;CFRunLoopWakeUp &#x51FD;&#x6570;&#x548C; GCD &#x4E8B;&#x4EF6;&#xFF08;&#x5982;&#x679C;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#xFF09;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span>
        <span class="hljs-comment">//// &#x4F7F;&#x7528; GCD timer &#x4F5C;&#x4E3A; timer &#x5B9E;&#x73B0;&#x7684;&#x60C5;&#x51B5;</span>
        <span class="hljs-keyword">do</span> {
            msg = (<span class="hljs-keyword">mach_msg_header_t</span> *)msg_buffer;

            <span class="hljs-comment">//// &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4F1A;&#x7761;&#x7720;&#x7EBF;&#x7A0B;</span>
            __CFRunLoopServiceMachPort(waitSet, <span class="hljs-comment">// &#x76D1;&#x542C;&#x7AEF;&#x53E3;&#x96C6;&#x5408;    </span>
                                       &amp;msg, 
                                       <span class="hljs-keyword">sizeof</span>(msg_buffer), 
                                       &amp;livePort, <span class="hljs-comment">// &#x8FD4;&#x56DE;&#x6536;&#x5230;&#x6D88;&#x606F;&#x7684;&#x7AEF;&#x53E3;</span>
                                       poll ? <span class="hljs-number">0</span> : TIMEOUT_INFINITY, <span class="hljs-comment">// &#x6839;&#x636E;&#x72B6;&#x6001;&#x7761;&#x7720;&#x6216;&#x8005;&#x4E0D;&#x7761;</span>
                                       &amp;voucherState, 
                                       &amp;voucherCopy);

            <span class="hljs-comment">//// &#x5982;&#x679C;&#x662F; timer &#x7AEF;&#x53E3;&#x5524;&#x9192;&#x7684;&#xFF0C;&#x8FDB;&#x884C;&#x4E00;&#x4E0B;&#x5584;&#x540E;&#x5904;&#x7406;&#xFF0C;&#x4E4B;&#x540E;&#x518D;&#x5904;&#x7406; timer</span>
            <span class="hljs-keyword">if</span> (modeQueuePort != MACH_PORT_NULL 
                &amp;&amp; livePort == modeQueuePort) {
                <span class="hljs-comment">// Drain the internal queue. If one of the callout blocks sets the timerFired flag, break out and service the timer.</span>
                <span class="hljs-keyword">while</span> (_dispatch_runloop_root_queue_perform_4CF(rlm-&gt;_queue))
                    ;
                <span class="hljs-keyword">if</span> (rlm-&gt;_timerFired) {
                    <span class="hljs-comment">// Leave livePort as the queue port, and service timers below</span>
                    rlm-&gt;_timerFired = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">break</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (msg &amp;&amp; msg != (<span class="hljs-keyword">mach_msg_header_t</span> *)msg_buffer) <span class="hljs-built_in">free</span>(msg);
                }
            } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">//// &#x4E0D;&#x662F; timer &#x7AEF;&#x53E3;&#x5524;&#x9192;&#x7684;&#xFF0C;&#x8FDB;&#x884C;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x5904;&#x7406;</span>
                <span class="hljs-comment">// Go ahead and leave the inner loop.</span>
                <span class="hljs-keyword">break</span>;
            }
        } <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
        <span class="hljs-comment">///// &#x4E0D;&#x4F7F;&#x7528; GCD timer &#x4F5C;&#x4E3A; timer &#x5B9E;&#x73B0;&#x7684;&#x60C5;&#x51B5;</span>
        msg = (<span class="hljs-keyword">mach_msg_header_t</span> *)msg_buffer;
        __CFRunLoopServiceMachPort(waitSet, 
                                   &amp;msg, 
                                   <span class="hljs-keyword">sizeof</span>(msg_buffer), 
                                   &amp;livePort, 
                                   poll ? <span class="hljs-number">0</span> : TIMEOUT_INFINITY, 
                                   &amp;voucherState, 
                                   &amp;voucherCopy);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

        __CFRunLoopLock(rl);
        __CFRunLoopModeLock(rlm);

        <span class="hljs-comment">//// &#x589E;&#x52A0;&#x8BB0;&#x5F55;&#x7684;&#x7761;&#x7720;&#x65F6;&#x95F4;</span>
        rl-&gt;_sleepTime += (poll ? <span class="hljs-number">0.0</span> : (CFAbsoluteTimeGetCurrent() - sleepStart));

        <span class="hljs-comment">// Must remove the local-to-this-activation ports in on every loop</span>
        <span class="hljs-comment">// iteration, as this mode could be run re-entrantly and we don&apos;t</span>
        <span class="hljs-comment">// want these ports to get serviced. Also, we don&apos;t want them left</span>
        <span class="hljs-comment">// in there if this function returns.</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __HAS_DISPATCH__</span>
        <span class="hljs-comment">//// &#x5C06; GCD &#x7AEF;&#x53E3;&#x79FB;&#x9664;</span>
        __CFPortSetRemove(dispatchPort, waitSet);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

        __CFRunLoopSetIgnoreWakeUps(rl);

        <span class="hljs-comment">// user callouts now OK again</span>
        __CFRunLoopUnsetSleeping(rl);
        <span class="hljs-comment">//// 10. &#x901A;&#x77E5; observers: kCFRunLoopAfterWaiting, &#x5373;&#x505C;&#x6B62;&#x7B49;&#x5F85;&#xFF08;&#x88AB;&#x5524;&#x9192;&#xFF09;</span>
        <span class="hljs-comment">//// &#x6CE8;&#x610F;&#x5B9E;&#x9645;&#x5904;&#x7406;&#x8FC7; source 0 &#x6216;&#x8005;&#x5DF2;&#x7ECF;&#x8D85;&#x65F6;&#x7684;&#x8BDD;&#xFF0C;&#x4E0D;&#x4F1A;&#x901A;&#x77E5;&#xFF08;&#x56E0;&#x4E3A;&#x6CA1;&#x6709;&#x7761;&#xFF09;</span>
        <span class="hljs-keyword">if</span> (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);

        <span class="hljs-comment">//// 11. &#x88AB;&#x4EC0;&#x4E48;&#x5524;&#x9192;&#x5C31;&#x5904;&#x7406;&#x4EC0;&#x4E48;&#xFF1A;</span>
    handle_msg:;
        __CFRunLoopSetIgnoreWakeUps(rl);

        <span class="hljs-keyword">if</span> (MACH_PORT_NULL == livePort) {
            <span class="hljs-comment">//// &#x4E0D;&#x77E5;&#x9053;&#x54EA;&#x4E2A;&#x7AEF;&#x53E3;&#x5524;&#x9192;&#x7684;&#xFF08;&#x6216;&#x8005;&#x6839;&#x672C;&#x6CA1;&#x7761;&#xFF09;&#xFF0C;&#x5565;&#x4E5F;&#x4E0D;&#x5E72;</span>
            CFRUNLOOP_WAKEUP_FOR_NOTHING();
            <span class="hljs-comment">// handle nothing</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (livePort == rl-&gt;_wakeUpPort) {
            <span class="hljs-comment">//// &#x88AB; CFRunLoopWakeUp &#x51FD;&#x6570;&#x5F04;&#x9192;&#x7684;&#xFF0C;&#x5565;&#x4E5F;&#x4E0D;&#x5E72;</span>
            CFRUNLOOP_WAKEUP_FOR_WAKEUP();
            <span class="hljs-comment">// do nothing on Mac OS</span>
        }
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) {
            <span class="hljs-comment">//// &#x88AB; timers &#x5524;&#x9192;&#xFF0C;&#x5904;&#x7406; timers</span>
            CFRUNLOOP_WAKEUP_FOR_TIMER();
            <span class="hljs-keyword">if</span> (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) {
                <span class="hljs-comment">// Re-arm the next timer, because we apparently fired early</span>
                __CFArmNextTimerInMode(rlm, rl);
            }
        }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_MK_TIMER_TOO</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rlm-&gt;_timerPort != MACH_PORT_NULL &amp;&amp; livePort == rlm-&gt;_timerPort) {
            <span class="hljs-comment">//// &#x88AB; timers &#x5524;&#x9192;&#xFF0C;&#x5904;&#x7406; timers</span>
            CFRUNLOOP_WAKEUP_FOR_TIMER();
            <span class="hljs-comment">// On Windows, we have observed an issue where the timer port is set before the time which we requested it to be set. For example, we set the fire time to be TSR 167646765860, but it is actually observed firing at TSR 167646764145, which is 1715 ticks early. The result is that, when __CFRunLoopDoTimers checks to see if any of the run loop timers should be firing, it appears to be &apos;too early&apos; for the next timer, and no timers are handled.</span>
            <span class="hljs-comment">// In this case, the timer port has been automatically reset (since it was returned from MsgWaitForMultipleObjectsEx), and if we do not re-arm it, then no timers will ever be serviced again unless something adjusts the timer list (e.g. adding or removing timers). The fix for the issue is to reset the timer here if CFRunLoopDoTimers did not handle a timer itself. 9308754</span>
            <span class="hljs-keyword">if</span> (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) {
                <span class="hljs-comment">// Re-arm the next timer</span>
                __CFArmNextTimerInMode(rlm, rl);
            }
        }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __HAS_DISPATCH__</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (livePort == dispatchPort) {
            <span class="hljs-comment">//// &#x88AB; GCD &#x5524;&#x9192;&#x6216;&#x8005;&#x4ECE;&#x7B2C; 7 &#x6B65;&#x8DF3;&#x8F6C;&#x8FC7;&#x6765;&#x7684;&#x8BDD;&#xFF0C;&#x5904;&#x7406; GCD</span>
            CFRUNLOOP_WAKEUP_FOR_DISPATCH();
            __CFRunLoopModeUnlock(rlm);
            __CFRunLoopUnlock(rl);
            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (<span class="hljs-keyword">void</span> *)<span class="hljs-number">6</span>, <span class="hljs-literal">NULL</span>);
            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);
            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);
            __CFRunLoopLock(rl);
            __CFRunLoopModeLock(rlm);
            sourceHandledThisLoop = <span class="hljs-literal">true</span>;
            didDispatchPortLastTime = <span class="hljs-literal">true</span>;
        }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">//// &#x88AB; sources 1 &#x5524;&#x9192;&#xFF0C;&#x5904;&#x7406; sources 1</span>
            CFRUNLOOP_WAKEUP_FOR_SOURCE();
            <span class="hljs-comment">// Despite the name, this works for windows handles as well</span>
            CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);
            <span class="hljs-keyword">if</span> (rls) {
                <span class="hljs-keyword">mach_msg_header_t</span> *reply = <span class="hljs-literal">NULL</span>;
                sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;
                <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> != reply) {
                    (<span class="hljs-keyword">void</span>)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, <span class="hljs-number">0</span>, MACH_PORT_NULL, <span class="hljs-number">0</span>, MACH_PORT_NULL);
                    CFAllocatorDeallocate(kCFAllocatorSystemDefault, reply);
                }
            }

        }

        <span class="hljs-keyword">if</span> (msg &amp;&amp; msg != (<span class="hljs-keyword">mach_msg_header_t</span> *)msg_buffer) <span class="hljs-built_in">free</span>(msg);

        <span class="hljs-comment">//// 12. &#x518D;&#x4E00;&#x6B21;&#x5904;&#x7406; blocks</span>
        __CFRunLoopDoBlocks(rl, rlm);

        <span class="hljs-comment">//// 13. &#x5224;&#x65AD;&#x662F;&#x5426;&#x9000;&#x51FA;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x9000;&#x51FA;&#x5219;&#x8DF3;&#x8F6C;&#x56DE;&#x7B2C; 2 &#x6B65;</span>
        <span class="hljs-keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) {
            retVal = kCFRunLoopRunHandledSource;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (timeout_context-&gt;termTSR &lt; mach_absolute_time()) {
            retVal = kCFRunLoopRunTimedOut;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (__CFRunLoopIsStopped(rl)) {
            __CFRunLoopUnsetStopped(rl);
            retVal = kCFRunLoopRunStopped;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rlm-&gt;_stopped) {
            rlm-&gt;_stopped = <span class="hljs-literal">false</span>;
            retVal = kCFRunLoopRunStopped;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) {
            retVal = kCFRunLoopRunFinished;
        }

    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span> == retVal);
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __HAS_DISPATCH__</span>
    <span class="hljs-keyword">if</span> (timeout_timer) {
        dispatch_source_cancel(timeout_timer);
        dispatch_release(timeout_timer);
    } <span class="hljs-keyword">else</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
    {
        <span class="hljs-built_in">free</span>(timeout_context);
    }

    <span class="hljs-keyword">return</span> retVal;
}
</code></pre>
<h2 id="&#x53C2;&#x8003;">&#x53C2;&#x8003;</h2>
<ul>
<li><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html" target="_blank">Threading Programming Guide: Run Loops</a></li>
<li><a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank">&#x6DF1;&#x5165;&#x7406;&#x89E3;RunLoop</a></li>
<li><a href="http://v.youku.com/v_show/id_XODgxODkzODI0.html" target="_blank">iOS&#x7EBF;&#x4E0B;&#x5206;&#x4EAB;&#x300A;RunLoop&#x300B;by &#x5B59;&#x6E90;@sunnyxx</a></li>
<li><a href="https://github.com/apple/swift-corelibs-foundation" target="_blank">swift-corelibs-foundation</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="CFArray 的历史渊源及实现原理.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: CFArray 的历史渊源及实现原理">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Run Loop 记录与源码注释(作者Kylin)","level":"4.1.3","depth":2,"next":{"title":"UIKit","level":"5.1","depth":1,"ref":"","articles":[{"title":"复用的精妙 - UITableView 复用技术原理分析","level":"5.1.1","depth":2,"path":"Objective-C/Foundation/复用的精妙 - UITableView 复用技术原理分析.md","ref":"Objective-C/Foundation/复用的精妙 - UITableView 复用技术原理分析.md","articles":[]}]},"previous":{"title":"CFArray 的历史渊源及实现原理","level":"4.1.2","depth":2,"path":"Objective-C/Foundation/CFArray 的历史渊源及实现原理.md","ref":"Objective-C/Foundation/CFArray 的历史渊源及实现原理.md","articles":[]},"dir":"ltr"},"config":{"plugins":["splitter","github","multipart"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"github":{"url":"https://github.com/Desgard"},"splitter":{},"search":{},"multipart":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"language":"cn","gitbook":"*"},"file":{"path":"Objective-C/Foundation/Run Loop 记录与源码注释.md","mtime":"2017-10-11T16:29:39.000Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-10-13T15:07:45.685Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

